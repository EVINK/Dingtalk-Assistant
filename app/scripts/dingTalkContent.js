var __awaiter=this&&this.__awaiter||function(r,a,s,c){return new(s=s||Promise)(function(e,n){function t(e){try{i(c.next(e))}catch(e){n(e)}}function o(e){try{i(c.throw(e))}catch(e){n(e)}}function i(n){n.done?e(n.value):new s(function(e){e(n.value)}).then(t,o)}i((c=c.apply(r,a||[])).next())})},__generator=this&&this.__generator||function(t,o){var i,r,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function n(n){return function(e){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,r&&(a=2&n[0]?r.return:n[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,n[1])).done)return a;switch(r=0,a&&(n=[2&n[0],a.value]),n[0]){case 0:case 1:a=n;break;case 4:return s.label++,{value:n[1],done:!1};case 5:s.label++,r=n[1],n=[0];continue;case 7:n=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){s.label=n[1];break}if(6===n[0]&&s.label<a[1]){s.label=a[1],a=n;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(n);break}a[2]&&s.ops.pop(),s.trys.pop();continue}n=o.call(t,s)}catch(e){n=[6,e],r=0}finally{i=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,e])}}},DingTalkContent=function(){function i(){this.dingTalkFullScreenStyle=document.createElement("style"),this.newMessageNotificationLock=!1,this.notificationBanListKey="newMessageBanList",this.globalNotificationLockKey="notificationLock",this.dingTalkFullScreenStyle.id="dingTalkFullScreenStyle",generaPageContent.head.appendChild(this.dingTalkFullScreenStyle),this.init()}return i.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var o,n=this;return __generator(this,function(e){return this.initDingTalkStyle(),i.checkLSPStatus(),o=this,chrome.runtime.onMessage.addListener(function(e,n,t){e.message.fullScreen?o.genFullScreenDingTalk():!1===e.message.fullScreen?o.genRawDingTalkStyle():e.message.initDingTalkStyle?o.initDingTalkStyle():e.message.checkLSPStatus&&i.checkLSPStatus(),t({result:"success"})}),chrome.runtime.sendMessage({storeDtId:!0}),window.onload=function(){n.newMessageListener(),n.initMessageSelector()},[2]})})},i.prototype.genFullScreenDingTalk=function(){this.dingTalkFullScreenStyle.innerHTML="\n                            #layout-main {\n                                width: 100%;\n                                height: 100%;\n                            }\n                            #body {\n                                height: 100%;\n                            }\n                            #layout-container {\n                                display: block;\n                            }\n    "},i.prototype.genRawDingTalkStyle=function(){this.dingTalkFullScreenStyle.innerHTML+="\n                            #layout-main {\n                                width: 1000px;\n                            }\n                            #body {\n                                height: 542px;\n                            }\n                            #layout-container {\n                                display: flex;\n                            }\n    "},i.prototype.initDingTalkStyle=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,StorageArea.get("fullScreen")];case 1:return e.sent()?this.genFullScreenDingTalk():this.genRawDingTalkStyle(),[2]}})})},i.checkLSPStatus=function(){return __awaiter(this,void 0,void 0,function(){var n,t,o;return __generator(this,function(e){switch(e.label){case 0:return[4,StorageArea.get("loginStatusPersistence")];case 1:return e.sent()?(n="LSPScript-of-EVINK",document.querySelector("#"+n)?[2]:("\n            var loginStatusKeep = setInterval(function () {\n                if (window.sessionStorage.getItem('EvinK') === 'Handsome') {\n                    var element = document.createElement('div');\n                    element.id = 'LSPScript-finished-EvinK';\n                    document.body.appendChild(element);\n                    return clearInterval(loginStatusKeep); \n                }\n                var wkToken = window.sessionStorage.getItem('wk_token');\n                if (!wkToken) return;\n                wkToken = JSON.parse(wkToken);\n                // if (wkToken.isAutoLogin) return clearInterval(loginStatusKeep);\n                if (wkToken.isAutoLogin) {\n                    window.sessionStorage.setItem('EvinK', 'Handsome');\n                    return location.reload();\n                }\n                wkToken.isAutoLogin = true;\n                // console.log(JSON.stringify(wkToken));\n                window.sessionStorage.setItem('wk_token', JSON.stringify(wkToken));\n            }, 1000)\n        ",(t=document.createElement("script")).id=n,t.innerHTML+="\n            var loginStatusKeep = setInterval(function () {\n                if (window.sessionStorage.getItem('EvinK') === 'Handsome') {\n                    var element = document.createElement('div');\n                    element.id = 'LSPScript-finished-EvinK';\n                    document.body.appendChild(element);\n                    return clearInterval(loginStatusKeep); \n                }\n                var wkToken = window.sessionStorage.getItem('wk_token');\n                if (!wkToken) return;\n                wkToken = JSON.parse(wkToken);\n                // if (wkToken.isAutoLogin) return clearInterval(loginStatusKeep);\n                if (wkToken.isAutoLogin) {\n                    window.sessionStorage.setItem('EvinK', 'Handsome');\n                    return location.reload();\n                }\n                wkToken.isAutoLogin = true;\n                // console.log(JSON.stringify(wkToken));\n                window.sessionStorage.setItem('wk_token', JSON.stringify(wkToken));\n            }, 1000)\n        ",document.body.appendChild(t),[4,StorageArea.get("loginStatusPersistence")])):[2];case 2:return e.sent()&&(o=setInterval(function(){if(document.querySelector("#LSPScript-finished-EvinK"))return generaPageContent.genBubbleMsg("登录状态已保存"),clearInterval(o)},1e3)),[2]}})})},i.prototype.newMessageListener=function(){var n=this,a=this;function o(r){return __awaiter(this,void 0,void 0,function(){var n,t,o,i;return __generator(this,function(e){switch(e.label){case 0:return r.querySelector(".unread-num.ng-scope")?(n=r.parentElement.parentElement,t=n.querySelector('.latest-msg span[ng-bind-html="convItem.conv.lastMessageContent|emoj"]'),o=n.querySelector(".name-wrap .name-title.ng-binding"),t.textContent&&o.textContent?[4,StorageArea.get(a.notificationBanListKey)]:[2]):[3,2];case 1:return 0<=(e.sent()||[]).indexOf(o.textContent)?[2]:(20<(i=t.textContent).length&&(i=i.slice(0,20)+"..."),[2,chrome.runtime.sendMessage({chromeNotification:{title:"钉钉 - "+o.textContent,message:i}})]);case 2:return[2]}})})}var t=new MutationObserver(function(e){e.forEach(function(t){return __awaiter(n,void 0,void 0,function(){var n;return __generator(this,function(e){switch(e.label){case 0:return[4,StorageArea.get(this.globalNotificationLockKey)];case 1:if(e.sent())return[2];if(this.newMessageNotificationLock)return[2];if("characterData"===t.type){if(0<=t.target.parentElement.className.indexOf("time"))return[2];if(0<=(n=t.target.parentElement.parentElement.parentElement).className.indexOf("noti"))return[2,o(n)]}else if(0<=t.target.className.indexOf("noti"))return[2,o(t.target)];return[2]}})})})}),i={childList:!0,subtree:!0,characterData:!0},r=setInterval(function(){var e=document.querySelector("#sub-menu-pannel");e&&(clearInterval(r),t.observe(e,i))},1e3)},i.prototype.initMessageSelector=function(){return __awaiter(this,void 0,void 0,function(){function n(){r.newMessageNotificationLock=!0,setTimeout(function(){return r.newMessageNotificationLock=!1},1e3),h=[];for(var e=0,n=p;e<n.length;e++){n[e].remove()}u.appendChild(d),g.remove(),f.remove()}var t,u,d,o,i,g,f,h,p,r,a=this;return __generator(this,function(e){switch(e.label){case 0:return[4,function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(n){var t=setInterval(function(){var e=document.querySelector("#header");if(e)return clearInterval(t),void n(e)},1e3)})]})})}()];case 1:return t=e.sent(),(u=document.createElement("div")).classList.add("contact-selector-area-EVINK"),t.appendChild(u),u.innerHTML+="\n        <style>\n        div.contact-selector-area-EVINK {\n        position: absolute;\n        top: 0;\n        left: 130px;\n        width: 100px;\n        height: 100%;\n        display: flex;\n        flex-flow: row;\n        justify-content: space-evenly;\n        align-items: center;\n        }\n        div.contact-selector-area-EVINK a {\n        color: white;\n        cursor: pointer;\n        }\n        .contact-cover-box-EVINK {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: #00000033;\n        overflow: hidden;\n        }\n        .contact-cover-box-EVINK::after, .contact-cover-box-EVINK::before{\n        content: '';\n        position: absolute;\n        }\n        .contact-cover-box-EVINK::before{ \n        left: 13px;\n        width: 38px;\n        height: 38px;\n        border-radius: 50%;\n        }\n        .contact-cover-box-EVINK::after{ \n        left: 20px;\n        width: 24px;\n        height: 100%;\n        }\n        .contact-cover-box-hover-EVINK::after {\n        top: 100%;\n        background: no-repeat center/100% url(\""+chrome.extension.getURL("assets/imgs/notification-disable-red.svg")+'");\n        }\n        .contact-cover-box-hover-EVINK::before {\n        top: 100%;\n        background: #000000ab;\n        }\n        .contact-cover-box-hover-EVINK:hover::before {\n        top: 9px;\n        }\n        .contact-cover-box-hover-EVINK:hover::after {\n        top: 0;\n        }\n        .contact-cover-box-permanent-EVINK::after {\n        top: 0;\n        background: no-repeat center/100% url("'+chrome.extension.getURL("assets/imgs/notification-disable-white.svg")+'");\n        }\n        .contact-cover-box-permanent-EVINK::before {\n        top: 9px;\n        background: #ff0000cf;\n        }\n        </style>\n        ',d=document.createElement("a"),u.appendChild(d),d.style.display="flex",d.style.justifyContent="center",d.style.alignItems="center",o=new Image,d.appendChild(o),o.src=chrome.extension.getURL("assets/imgs/notification-setting.svg"),o.style.width="18px",i=document.createElement("span"),d.appendChild(i),i.textContent="通知设置",g=document.createElement("a"),o=new Image,g.appendChild(o),o.src=chrome.extension.getURL("assets/imgs/finish.svg"),o.style.width="26px",f=document.createElement("a"),o=new Image,f.appendChild(o),o.src=chrome.extension.getURL("assets/imgs/cancel.svg"),o.style.width="26px",h=[],p=[],d.onclick=function(e){return __awaiter(a,void 0,void 0,function(){var n,r,a,t,o,i,s,c,l=this;return __generator(this,function(e){switch(e.label){case 0:return[4,StorageArea.get(this.globalNotificationLockKey)];case 1:return e.sent()?[2,GeneralPageContent.alert("通知已被禁用，若要启用通知，请前往设置页")]:[4,StorageArea.get(this.notificationBanListKey)];case 2:if(h=(h=e.sent())||[],n="contact-cover-box-EVINK",document.querySelector("."+n))return[2];if(r="contact-cover-box-permanent-EVINK",a="contact-cover-box-hover-EVINK",d.remove(),u.appendChild(g),u.appendChild(f),this.newMessageNotificationLock=!0,setTimeout(function(){return l.newMessageNotificationLock=!1},1e3),!(t=document.querySelectorAll("#sub-menu-pannel .conv-lists-box.ng-isolate-scope conv-item div.conv-item:first-child")))return[2,sendMessage({bubble:"没有找到最近联系人"})];for(t=Array.from(t),o=function(e){var t=document.createElement("div");e.appendChild(t),t.classList.add(n);var o=!1,i=e.querySelector('p.name span[ng-bind-html="convItem.conv.i18nTitle|emoj"]');0<=h.indexOf(i.textContent)?(t.classList.add(r),o=!0):t.classList.add(a),t.onclick=function(e){if(o){t.classList.remove(r),t.classList.add(a);var n=h.indexOf(i.textContent);0<=n&&h.splice(n,1),o=!1}else t.classList.remove(a),t.classList.add(r),h.push(i.textContent),o=!0;e.stopPropagation()},p.push(t)},i=0,s=t;i<s.length;i++)c=s[i],o(c);return[2]}})})},r=this,g.onclick=function(){var e={};e[a.notificationBanListKey]=h,StorageArea.set(e),n()},f.onclick=function(){n()},[2]}})})},i}();new DingTalkContent;