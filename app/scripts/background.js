var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(a,o,s,c){return new(s=s||Promise)(function(e,t){function n(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(n,r)}i((c=c.apply(a,o||[])).next())})},__generator=this&&this.__generator||function(n,r){var i,a,o,e,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;s;)try{if(i=1,a&&(o=2&t[0]?a.return:t[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,t[1])).done)return o;switch(a=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,a=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){s.label=t[1];break}if(6===t[0]&&s.label<o[1]){s.label=o[1],o=t;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(t);break}o[2]&&s.ops.pop(),s.trys.pop();continue}t=r.call(n,s)}catch(e){t=[6,e],a=0}finally{i=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},_this=this;chrome.tabs.onActivated.addListener(function(t){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,StorageArea.get("dtId")];case 1:return e.sent()===t.tabId&&(sendMessage({initDingTalkStyle:!0}),sendMessage({checkLSPStatus:!0})),[2]}})})}),chrome.runtime.onMessage.addListener(function(t,n,r){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return t.storeDtId?(StorageArea.set({dtId:n.tab.id}),[3,5]):[3,1];case 1:return t.snapshot?(chrome.tabs.captureVisibleTab(null,{},function(e){sendMessage({snapshot:e})}),[3,5]):[3,2];case 2:return t.chromeNotification?[4,Notify.sendChromeNotification(t.chromeNotification)]:[3,4];case 3:return e.sent(),[3,5];case 4:t.versionCheck&&new VersionCheck,e.label=5;case 5:return r({result:"success"}),[2]}})})});var Notify=function(){function r(){}return r.sendChromeNotification=function(n){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return r.lastNotificationId?[4,this.clearChromeNotification()]:[3,2];case 1:e.sent(),e.label=2;case 2:return n.type||(n.type="basic"),n.iconUrl||(n.iconUrl=chrome.extension.getURL("icon.png")),[2,new Promise(function(t){chrome.notifications.create(null,__assign({},n),function(e){if(chrome.runtime.lastError)return console.log(chrome.runtime.lastError.message);t(r.lastNotificationId=e)})})]}})})},r.clearChromeNotification=function(){var e=this;return new Promise(function(n){chrome.notifications.clear(r.lastNotificationId,function(t){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(e){return n(t),[2]})})})})},r.lastNotificationId=void 0,r}(),VersionCheck=function(){function i(){i.create(),i.event()}return i.create=function(){chrome.alarms.get(i.alarmName,function(e){e||chrome.alarms.create(i.alarmName,{when:Date.now(),periodInMinutes:180})})},i.clear=function(){chrome.alarms.clear(i.alarmName,function(e){e&&console.log("alarm was removed")})},i.getLatestVersion=function(){return __awaiter(this,void 0,void 0,function(){var t,n,r;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),[4,fetch(i.endpoint)];case 1:return 200!==(t=e.sent()).status?[2]:[4,t.text()];case 2:return n=e.sent(),[4,StorageArea.get("versionAlarmed")];case 3:return e.sent()===n?[2]:(chrome.runtime.getManifest().version!==n&&(Notify.sendChromeNotification({title:"钉钉助手有可用的新版本-v"+n,message:"可前往设置页禁用新版本检查"}),StorageArea.set({versionAlarmed:n})),[3,5]);case 4:return r=e.sent(),console.log(r),[2];case 5:return[2]}})})},i.event=function(){var e=this;chrome.alarms.onAlarm.addListener(function(n){return __awaiter(e,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return n.name!==i.alarmName?[3,2]:[4,StorageArea.get("versionCheck")];case 1:if("boolean"!=typeof(t=e.sent())&&(t=!0),!t)return[2,i.clear()];i.getLatestVersion(),e.label=2;case 2:return[2]}})})})},i.alarmName="versionCheckAlarm",i.endpoint="https://api.evink.cn/dt/version",i}();new VersionCheck;