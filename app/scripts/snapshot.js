var Snapshot=function(){function v(e){this.father=document.createElement("div"),this.isClickBegun=!1,this.father.id="snapshot-unique-of-this-window-EvinK",document.getElementById(this.father.id)||(this.canvas=e,this.father.appendChild(this.canvas),document.body.append(this.father),this.genBgCover(),this.event())}return v.prototype.genCoverStyle=function(e){var t=e.top,o=e.left,i=e.width,n=e.height;return"\n            margin: 0;\n            padding: 0;\n            position: fixed;\n            top: "+(t=t||0)+"px;\n            left: "+(o=o||0)+"px;\n            width: "+(null==i?"100vw":i+"px")+";\n            height: "+(null==n?document.body.clientHeight+"px":n+"px")+";\n            background: #0000008f;\n            z-index: "+v.highestZIndex+";\n            "},v.prototype.genBgCover=function(){if(this.previewBox){this.cover.style.background&&this.cover.style.removeProperty("background");var e=v.bgCoverId+"-left",t=v.bgCoverId+"-right",o=v.bgCoverId+"-top",i=v.bgCoverId+"-bottom";this.coverLeft=document.getElementById(e),this.coverRight=document.getElementById(t),this.coverTop=document.getElementById(o),this.coverBottom=document.getElementById(i),this.coverLeft||(this.coverLeft=document.createElement("div"),this.coverLeft.id=e,this.father.append(this.coverLeft)),this.coverRight||(this.coverRight=document.createElement("div"),this.coverRight.id=t,this.father.append(this.coverRight)),this.coverTop||(this.coverTop=document.createElement("div"),this.coverTop.id=o,this.father.append(this.coverTop)),this.coverBottom||(this.coverBottom=document.createElement("div"),this.coverBottom.id=i,this.father.append(this.coverBottom));var n=document.body.clientWidth-this.previewBox.offsetLeft-this.previewBox.offsetWidth;this.coverLeft.setAttribute("style",this.genCoverStyle({width:this.previewBox.offsetLeft})),this.coverRight.setAttribute("style",this.genCoverStyle({left:this.previewBox.offsetLeft+this.previewBox.offsetWidth,width:n})),this.coverTop.setAttribute("style",this.genCoverStyle({left:this.previewBox.offsetLeft,height:this.previewBox.offsetTop,width:document.body.clientWidth-this.previewBox.offsetLeft-n})),this.coverBottom.setAttribute("style",this.genCoverStyle({left:this.previewBox.offsetLeft,top:this.previewBox.offsetTop+this.previewBox.offsetHeight,height:document.body.clientHeight-this.previewBox.offsetTop-this.previewBox.offsetHeight,width:document.body.clientWidth-this.previewBox.offsetLeft-n}))}else{var r=document.getElementById(v.bgCoverId);if(r)return r;(r=document.createElement("div")).id=v.bgCoverId,r.setAttribute("style","\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100vw;\n            height: "+document.body.clientHeight+"px;\n            background: #0000008f;\n            z-index: "+(v.highestZIndex+2)+";\n            cursor: crosshair;\n            "),this.father.append(r),this.cover=r}},v.prototype.genPreviewBox=function(e,t){var h=this;this.previewBox=document.createElement("div"),this.previewBox.setAttribute("startX",e.toString()),this.previewBox.setAttribute("startY",t.toString()),this.previewBox.setAttribute("id","dt-preview"),this.previewBox.setAttribute("style","\n        width: 1px;\n        height: 1px;\n        border: 2px dashed gray;\n        background: transparent;\n        position: fixed;\n        top: "+t+"px;\n        left: "+e+"px;\n        z-index: "+(v.highestZIndex+1)+";\n        cursor: move;\n        "),this.father.append(this.previewBox),this.statusBar=document.createElement("div"),this.previewBox.append(this.statusBar),this.statusBar.setAttribute("style","\n        position: absolute;\n        top: -25px;\n        left: 0;\n        display: inline-block;\n        text-indent: 10px;\n        width: 87px;\n        line-height: 22px;\n        background: black;\n        color: white;\n        border-radius: 10px;\n        "),this.statusBar.innerText="(1, 1)",this.previewBoxToolsBar=document.createElement("div"),this.previewBox.append(this.previewBoxToolsBar),this.previewBoxToolsBar.setAttribute("style","\n        position: absolute;\n        bottom: -35px;\n        right: 0;\n        display: block;\n        min-width: 75px;\n        height: 35px;\n        background: black;\n        color: white;\n        border-radius: 10px;\n        "),this.previewBoxToolsBar.innerHTML+="\n        <style>\n          ul#tools-of-toolsBar-EvinK {\n            display: flex;\n            flex-flow: row;\n            justify-content: flex-end;\n            align-items: center;\n            cursor: default;\n            width: 90%;\n            height: 100%;\n            list-style: none;\n            /* some site will interference this style */\n            /* so there is a duplicate mention */\n            margin: 0;\n            padding: 0;\n          }\n          ul#tools-of-toolsBar-EvinK li {\n            cursor: pointer;\n          }\n          ul#tools-of-toolsBar-EvinK li img{\n            width: 30px;\n          }\n        </style>\n        ";var o=document.createElement("ul");o.id="tools-of-toolsBar-EvinK",this.previewBoxToolsBar.appendChild(o),o.onmousemove=function(e){return e.cancelBubble=!0},o.onmouseup=function(e){return e.cancelBubble=!0},o.onmousedown=function(e){return e.cancelBubble=!0};var i=document.createElement("li");o.appendChild(i);var n=new Image;i.appendChild(n),n.src=chrome.extension.getURL("assets/imgs/download.svg"),i.onclick=function(){var e=parseInt(h.previewBox.getAttribute("startX")),t=parseInt(h.previewBox.getAttribute("startY")),o=e+h.previewBox.clientWidth,i=t+h.previewBox.clientHeight;v.cropCanvas(h.canvas,{x:e,y:t},{x:o,y:i}).toBlob(function(e){var t=window.URL,o=document.createElement("a");o.download=(new Date).getTime()+".png",o.href=t.createObjectURL(e),o.dataset.downloadurl=["png",o.download,o.href].join(":"),o.click(),h.destroySnapshot(),generaPageContent.genBubbleMsg("已保存图片")})},i=document.createElement("li"),o.appendChild(i),n=new Image,i.appendChild(n),n.src=chrome.extension.getURL("assets/imgs/ok.svg"),i.onclick=function(){var e=parseInt(h.previewBox.getAttribute("startX")),t=parseInt(h.previewBox.getAttribute("startY")),o=e+h.previewBox.clientWidth,i=t+h.previewBox.clientHeight,n=v.cropCanvas(h.canvas,{x:e,y:t},{x:o,y:i}).toDataURL("image/png"),r=new Image;h.father.appendChild(r),r.src=n;var s=window.devicePixelRatio||1;r.style.transform="scale("+(2-s)+")";var a=document.createRange(),p=document.getSelection();a.selectNode(r),p.removeAllRanges(),p.addRange(a),document.execCommand("copy"),h.destroySnapshot(),generaPageContent.genBubbleMsg("图片已复制"),setTimeout(function(){return generaPageContent.genBubbleMsg("注意,在富文本编辑器中才能粘贴哦")},500)}},v.prototype.event=function(){var a=this;this.cover&&(this.cover.addEventListener("mousedown",function(e){a.isClickBegun||(a.isClickBegun=!0,a.genPreviewBox(e.offsetX,e.offsetY),a.genBgCover())}),this.cover.onmousemove=function(e){if(a.previewBox&&a.isClickBegun){var t=parseInt(a.previewBox.getAttribute("startX")),o=parseInt(a.previewBox.getAttribute("startY")),i=e.offsetX-t,n=e.offsetY-o;i<0&&(a.previewBox.style.left=t-Math.abs(i)+"px"),n<0&&(a.previewBox.style.top=o-Math.abs(n)+"px"),a.previewBox.style.width=Math.abs(i)+"px",a.previewBox.style.height=Math.abs(n)+"px",a.statusBar&&(a.statusBar.innerText="("+Math.abs(e.offsetX)+", "+Math.abs(e.offsetY)+")"),a.genBgCover()}},this.cover.onmouseup=function(e){var t=parseInt(a.previewBox.getAttribute("startX")),o=parseInt(a.previewBox.getAttribute("startY")),i=e.offsetX-t,n=e.offsetY-o;i<0&&a.previewBox.setAttribute("startX",e.offsetX.toString()),n<0&&a.previewBox.setAttribute("startY",e.offsetY.toString()),a.isClickBegun=!1,a.cover.remove(),a.previewBox.onmousedown=function(e){a.previewBox.setAttribute("mouseDownX",e.offsetX.toString()),a.previewBox.setAttribute("mouseDownY",e.offsetY.toString()),a.previewBox.setAttribute("mouseDown","1")},a.previewBox.onmousemove=function(e){if("1"===a.previewBox.getAttribute("mouseDown")){var t=parseInt(a.previewBox.getAttribute("startX")),o=parseInt(a.previewBox.getAttribute("startY")),i=parseInt(a.previewBox.getAttribute("mouseDownX")),n=parseInt(a.previewBox.getAttribute("mouseDownY"));if(i&&n){var r=t+e.offsetX-i,s=o+e.offsetY-n;a.previewBox.style.top=s+"px",a.previewBox.style.left=r+"px",a.genBgCover(),a.previewBox.setAttribute("startX",r.toString()),a.previewBox.setAttribute("startY",s.toString()),a.statusBar.innerText="("+Math.abs(r)+", "+Math.abs(s)+")"}}},a.previewBox.onmouseup=function(e){a.previewBox.setAttribute("mouseDown","0");var t=parseInt(a.previewBox.getAttribute("mouseDownX")),o=parseInt(a.previewBox.getAttribute("mouseDownY"));if(t&&o){var i=parseInt(a.previewBox.getAttribute("startX")),n=parseInt(a.previewBox.getAttribute("startY")),r=i+e.offsetX-t,s=n+e.offsetY-o;a.previewBox.setAttribute("startX",r.toString()),a.previewBox.setAttribute("startY",s.toString())}},a.previewBox.onmouseenter=function(){a.previewBox.style.cursor="move"},a.previewBox.onmouseleave=function(){a.previewBox.setAttribute("mouseDown","0")}})},v.cropCanvas=function(e,t,o){var i=window.devicePixelRatio||1,n=e.getContext("2d").getImageData(t.x*i,t.y*i,o.x*i,o.y*i),r=document.createElement("canvas");return r.width=(o.x-t.x)*i,r.height=(o.y-t.y)*i,r.getContext("2d").putImageData(n,0,0),r},v.prototype.destroySnapshot=function(){var o=this.father.id;this.father.remove();try{document.querySelectorAll("iframe").forEach(function(e){var t=e.contentWindow.document.getElementById(o);t&&t.remove()})}catch(e){console.error(e)}},v.bgCoverId="bgCover-snapshot-EvinK",v.highestZIndex=2147483645,v}();